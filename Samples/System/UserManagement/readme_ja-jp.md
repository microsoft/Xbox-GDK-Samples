  ![](./media/image1.png)

#   ユーザー管理のサンプル

*このサンプルは、Microsoft ゲーム開発キット (2020 年4月)
に対応しています。*

# 

# 説明

このサンプルでは、シングルユーザーおよびマルチユーザーのシナリオで、ゲームパッド関連付けのユーザー管理について示します。管理動作は、参照用の例として
XR
に対応するように作成されています。最後に、プロセスを超えたケースで、起動ツールを使って既定のユーザーを設定する方法についても説明します。

# サンプルの作成

Xbox One の devkit を使用している場合は、アクティブなソリューション
プラットフォームを Gaming.Xbox.XboxOne.x64 に設定します。

Project Scarlett を使用している場合は、アクティブなソリューション
プラットフォームを Gaming.Xbox.Scarlett.x64 に設定します。

*詳細については、*GDK ドキュメントの
「サンプルの実行」を参照してください。

# サンプルの使用

このサンプルは 3
つの画面に分かれており、ゲームパッドを使って切り替えることができます。入力はサンプルの画面に次のように表示されます。

[タイトル画面]{.underline}

![](./media/image3.png)

| 動作                             |  すべてのゲームパッド              |
|----------------------------------|-----------------------------------|
| ナビゲーション メニュー          |  方向パッドの上下                  |
| サインイン/選択メニュー オプション |  A ボタン |
| ユーザーの切り替え               |  Y ボタン                          |

[\
]{.underline}

[シングル ユーザー画面]{.underline}

![](./media/image4.png)

| 動作  |  す べてのゲームパッド |  ユーザーに関連付け られているゲームパッド  |
|----------------------|--------------------|-------------------------|
| タイトルに戻る  |  (ダイアログ が表示された場合) B ボタン |  メインメニューの選択 |
| サイン アウト延期の切り替え  |  該当なし  |  \[サインアウトの延期要求\]を選択                  |
| 選択/サ インイン/動作の確認 (ダイアログ) |  (ダイアログ が表示された場合) A ボタン | A ボタン|
| 動作のキャンセル (ダイアログ) |  B ボタン  | 該当なし|
| 移動​​                 |  該当なし           | 方向パッドの上下        |

[\
]{.underline}

[マルチユーザー画面]{.underline}

![](./media/image5.png)

| 動作  |  ペアリ ングされていな いゲームパッド |  ユーザーに関連 付けられているゲームパッド |
|----------------------|-----------------|----------------------------|
| タイトルに戻る (プライマリ ユーザー) |  該当なし  |  メインメニューの選択 |
| サインイン           |  A ボタン        |  該当なし                   |
| サインアウト (プライマリ ユーザー以外) |  該当なし  |  \[終了\] の選択|
| サイン アウト延期の切り替え |  該当なし  | \[サインアウトの延期要求\]を選択                     |
| 移動​​                 |  該当なし        | 方向パッドの上下           |

# 実装に関する注意事項

このサンプルでは、ユーザー管理機能をシングル
ユーザーのシナリオとマルチユーザーのシナリオに分けて説明します。シングル
ユーザー画面では、データ変更時やユーザー喪失時に、ユーザー
イベントを処理しつつ、単一のプライマリ
ユーザーを管理する方法を示します。マルチユーザー画面では、最大 4
人のユーザーがログインできます。

タイトル画面の「*Cross-Restart
Test*」オプションでは、ユーザーパラメーターと共に提供される
**XLaunchNewGame()**
を使用して既定のユーザーを新しいプロセスで設定する方法についても説明します。この機能が一般に使用されるのは、個別のシングル
プレーヤーバージョンおよびマルチプレイヤー
バージョンのゲームなど、個別の実行可能ファイルを起動する起動ツールを含むゲームです。このサンプルでは、これを使用して、スタート時にユーザーを選択するようにプロンプト表示するのではなく、既定のユーザーでゲームに直接サインインする方法を示します。

各種画面で示されるユーザー管理には多くの機能があります。機能とその使用方法については、次の表を参照してください。

| 特徴             |  説明                                              |
|------------------|---------------------------------------------------|
| サインイン  |  このサンプルでは、**XUserAddAsync ()** を使用してタイトル画面でプライマリ ユーザーをサインインします。 マルチユーザー画面では、最大 3 人の追加ユ ーザーをサンプルにサインインし、マルチプレイヤー ゲームをデモできます。                            |
| サインアウト  |  マルチユーザ ーのシナリオでは、サインインしている追加ユーザー (プライマリ以外) は、手動でサンプルからサインアウトできます。 プライマリ ユーザーは、この サンプルでは手動でサインアウトできませんが、Xbox システム UI など、他の手 段からのサインアウト時に喪失する場合があります。  |
| ユ ーザーの切り替え  |  プライマリ ユーザー を切り替えるには、タイトル画面で、新規ユーザーを **XUserAddAsync ()** でサインインし 、サインイン成功後に以前のユーザーを削除します。 マルチユーザー画面では、プライマリ ユーザー以外のユーザ ーは自由にサインインまたはサインアウトできます。  |
| ユー ザーなしのプレー  |  タイトル画面でプライマリ ユーザーが確立されていない場合、サインイン UI をキャンセル できます。この場合、サンプルは、データが保存され ない旨を通知し、ユーザーなしで続行することを確認 するメッセージを表示されます。この処理を続行する と、ユーザーなしでシングルユーザー画面にアクセス できます。このサンプルで「ユーザーなし」のプレー に使用できるアクションは、デバイス パネルでゲームパッドの入力を 表示することと、タイトル画面に戻ることのみです。  |
| ゲームパッドの ペアリングと入力  |  ユーザー デバイスの関連付けイベントは、ゲーム パッドのサインインしているすべてのユーザーとのペ アリングの最新情報を取得するために追跡されます。 入力は、画面の右側にある \[デバイス\]パネルで、ペアリングされたゲームパッドの画面に表示されます。ゲームパッドのペアリングは、サインインダイアログ、コントローラーのオン/オフの切り替え、Xboxシステム UI のユーザーアクションなど、さまざまなソースで変更されます。  |
| 既定ユー ザーのサインイン  | このサンプルでは、メニューオプション「Cross-RestartTest」を使用する場合の既定ユーザーのサインインについて示しています。新しいプロセスでは、**XUserAddAsync()** をシステム UI なしでサイ ンインを行う特別なフラグと一緒に使用します。サイ ンインに成功すると、このサンプルでは、タイトル画 面からシングルユーザー画面に自動的に移行します。  |
| **XLaunchNewGame ()** による クロスプロセスの 既定のサインイン  |  一部のゲームでは、 複数の実行可能ファイル、または複数のローディング シナリ オが存在する場合があります。クロスプロセスの起動 に既定のユーザーを設定するには、**XLaunchNewGame ()** を使用します。このサンプルでは、サンプルにユーザ ーを選択させることにより、これを実証します。新し く生成されたプロセスは、このユーザーを自動的にサ インインして、シングルユーザー画面に移行します。  |
| ユーザー データ  |  ゲーマータグおよびゲーマーアイコンは、サインイ ンしているすべてのユーザーの画面に表示されます。  |
| サインアウト延期  |  ユーザーが UI からサ インアウトを開始するとき、サインアウト延期を取得 して、サインアウトを数秒遅らせることができます。  |
| ユーザー イベントの処理  |  ユーザー イベントは、サインアウト、ゲーマー タグの変更、および ゲーマー アイコンの変更に対して処理されます。              |
| 処理の中断/再開  |  進行中のゲーマー アイコン要求は 、中断時にキャンセルされ、再開時に再開されます。 ユーザーのサインイン状態を修正するため、ユーザー イベントは後で再開されるように処理されます。 XR の考慮事項については、以下の XR のセクションを参照してください。                  |
| ゲスト ユーザー  |  ゲスト ユーザーは、マルチユーザー画面の **XUserAddAsync ()** からサインインできます。     |

[ERA XDK との違いに関するメモ:]{.underline}

Game Core のタイトルは、**XUserAddAsync ()**
関数を呼び出すことでゲームが要求したユーザーのみが利用できます。その結果、返されるユーザーがタイトルに追加されていない場合、ユーザーを返す
API
はエラーとなります。また、システムには、タイトルより多くのユーザーがサインインしている可能性もあります。タイトル
ユーザーを継続的かつ一貫して追跡し、ゲームパッドのペアリングを変更について、ユーザー
デバイスの関連付けコールバックを監視することが重要です。

[サンプル ファイル:]{.underline}

サンプルは、デモ用として、主に 3 つのコード領域に分かれています。

*GameInputDevice.cpp/h*

ゲームパッドの追跡と管理は、**GameInput API** を使って
**GameInputDevice** および **GameInputCollection**
クラスで処理されます。接続されたゲームの最新リストが維持され、入力をいずれかのデバイスに対して確認できます。

*GameUser.cpp/h*

ユーザー管理機能をデモするため、**GameUser** および **GameUserManager**
クラスを実装しています。これらのクラスは、ユーザーのサインイン、ゲームパッドの関連付けの更新、ユーザー
イベントの処理などの方法について示しています。

**GameUserManager**
は、汎用的な方法で実装されているため、シングルまたはマルチユーザーのシナリオに対応できます。

*GameScreens.cpp/h*

ここでは、タイトルの各種画面が実装されています。これらの画面は、サンプル
UI を表し、**GameUserManager**
機能を使ってユーザー管理機能を実証します。**GameUserManager**
のユーザーは **GameScreenManager**
から管理されます。これにより、さまざまなゲーム画面におけるゲーム
ユーザーの状態を、1 つの場所で追跡できます。

**GameScreenSingleUser** クラスはシングルユーザー
シナリオに似ており、**GameScreenMultiUser**
クラスは、マルチユーザー対応ゲームのマルチユーザー
バージョンです。**GameScreenTitle** は、タイトル画面のクラスです。

# Game Core の XR

Game Core のユーザー IＤ および管理用 XR は、対応する ERA
を簡略化したものです。コンプライアンスのため、このサンプルが準拠する関連要件は実質的に
3
つあり、次の通りです。「***XR-112**:初期アクティベーションおよび再開時のユーザーおよびコントローラーの確立」*、「***XR-115***:*ゲームプレー中のユーザーまたはコントローラーの追加と削除」、および「**XR-046**:表示名とユーザー
アイコン」。*各 XR およびサンプルが準拠する方法は以下の通りです。XR
に関する情報は<https://developer.microsoft.com/en-us/games/xbox/partner/certification-requirements>でご確認いただけます。

[**XR-112**:初期アクティベーションおよび再開時のユーザーおよびコントローラーの確立]{.underline}

要件の概要:

-   タイトルには、1 人または複数のプライマリ
    ユーザーを確立する必要があります。

    -   ユーザーがサインインをキャンセルする場合、ユーザーなしで操作を続行すると保存されないことを確認する警告を表示する必要があります。

-   ユーザー関連アクションを実行するには、まずユーザーを指定する必要があります。

-   プライマリ
    ユーザーを変更するには、タイトルはアカウントの選択に入力をが必要です。

-   中断または制止された状態から再開する場合、タイトルはユーザーおよびゲームパッドの関連付けを検証する必要があります。

このサンプルでは、次のように処理されます。

-   サインインしていない場合は、タイトル画面でアクティブなユーザーが確立されます。

-   アクティブなユーザーが例示目的で UI で指定されます。

-   プライマリ ユーザーの選択をキャンセルすると、警告が表示されます。

    -   プライマリ
        ユーザーがサインインしていない場合、マルチユーザーは無効になっていますが、シングルユーザー画面にはアクセスできます。

-   ゲームパッドのペアリングは常に更新され、ユーザー
    デバイスの関連付けコールバックで優先されます。

-   ユーザーがサインインし、関連付けられたゲームパッドがない場合は、ペアリングされていないゲームパッドを使用して再びサインインし、新しいゲームパッドを関連付けることができます。

-   アプリケーション再開時のイベントはすべて、ユーザー状態を修正するために処理されます。

[**XR-115**:ゲームプレー中のユーザーまたはコントローラーの追加と削除。]{.underline}

要件の概要:

-   プライマリ
    ユーザーおよびゲームパッドが確立されると、マルチプレーヤーのタイトルに追加のユーザーおよびゲームパッドを使用できます。必ず追加ユーザーがタイトルに追加される方法について考慮してください。

-   プレイヤーのコントローラーを削除した場合、タイトルは、デバイスの関連付けコールバックまたは
    **XUserAddAsync()**
    への呼び出しを使用して新規コントローラーの確立が可能です。

-   ゲームのプレー中にプレイヤーが削除された場合は、タイトルはプレーヤーを削除するか、ユーザーとアクティブ
    コントローラーを再確立する必要があります。

このサンプルでは、次のように処理されます。

-   タイトル画面またはマルチユーザー画面でプライマリ
    ユーザーを喪失した場合、サインイン
    プロンプトを表示してタイトル画面に戻ります。

-   シングルユーザー画面でプライマリ
    ユーザーが喪失した場合、ユーザーの再確立を試みるメッセージが表示されます。

-   マルチユーザー画面でプライマリ以外のユーザーを喪失した場合、そのユーザーはタイトルから削除されます。

-   ユーザーに関連付けられたゲームパッドが存在しない場合、ゲームパッドを確立するオプションが常に表示されます。

-   このサンプルでは、任意のゲームパッド、ペアリングされていないゲームパッド、またはペアリングされているゲームパッドを使ってアクションを処理できるケースについて分かりやすく説明します。

[**XR-046**:表示名とゲーマー アイコン]{.underline}

要件の概要:

-   Xbox Live を使用するゲーム タイトルは、プレイヤーのゲーム中の ID
    名として、プレイヤーのゲーマータグを使用する必要があります。

このサンプルでは、次のように処理されます。

-   このタイトルにはオンライン
    プレイがありませんが、サインインしているすべてのユーザーは、**XUserGetGamertag()**
    への呼び出しで返されたゲーマータグにより常に識別されます。

# 試してみること

次の各アクションは、ユーザー管理に関連する重要なシナリオをいくつか実証するうえで役立ちます。画面上の変更とデバッガーの出力ログを確認します。

1)  **動作**:起動後にタイトル画面でサインインを開始し、キャンセルする。\
    **確認:**サンプルは、続行すると保存が可能になるという警告メッセージを表示する。続行すると、サンプルはシングル
    ユーザー画面に進む。

2)  **動作**:タイトル画面でユーザーをサインインする。Y
    ボタンを使用して、ユーザーの切り替えを試してみる。\
    **確認:**ユーザーをいつでも変更できるように、プライマリ
    ユーザーはタイトル画面から変更可能である。

3)  **動作**:プライマリ ユーザーをサインインして、各種画面で Xbox
    システム UI を使用してユーザーをサインアウトする。\
    **確認:**各種画面がそれぞれの異なる動作をする。タイトルおよびマルチユーザー画面では、単にサインアウトへと進む。シングルユーザー画面には、再びサインインを許可するメッセージが表示される。

4)  **動作**:プライマリ
    ユーザーをサインインし、シングルユーザー画面に進む。次に、コントローラーをオフにする。\
    **確認:**画面に表示されているゲームパッドのペアリング情報は、オンになっているコントローラーおよびそれらのペアリング状態に基づいて変化する。オンになっているゲームパッドがない場合は、ゲームパッドが接続されていないことをユーザーに通知する。ペアリングされていないゲームパッドのみがオンになっている場合、ユーザーにペアリングされているゲームパッドがないことを示し、ペアリングされていないゲームパッドでサインインするための凡例をプロンプト表示する。

5)  **動作**:マルチユーザー画面で 1
    人または複数のユーザーをサンプルにサインインする。Xbox システム UI
    を使用して、ユーザーのゲーマータグまたはゲーム アイコンを変更する。\
    **確認:**ゲーマータグまたはゲーマーアイコンが更新され、サンプルに正しく表示される。

6)  **動作**:1 人または複数のユーザーをサンプルにサインインする。Xbox
    One Manager を使用してアプリケーションを中断し、1
    人または複数のユーザーを Xbox システム UI
    からサインアウトしてから、アプリケーションを再開する。\
    **確認:**アプリケーションは、ユーザーがサインインしている場合、正しいユーザーがサインインしている良好な状態であることを確認するため、適切な手段を実施する。プライマリ
    ユーザーが削除された場合、サンプルはそれを必要に応じて処理する。

7)  **動作**:複数のユーザーをマルチユーザー画面にサインインする。次に、Xbox
    システム UI
    を使用して、各種ゲームパッドで現在のユーザーを切り替える。\
    **確認:**ゲームパッドの関連付けがサインインしている各ユーザーの画面と一致するように更新される。

8)  **動作**:シングルユーザーまたはマルチユーザー画面で、複数のゲームパッドをオンにして、各種ゲームパッドのボタンを押す。\
    **確認:**どのように入力が適切なゲームパッドに帰属するかについて確認する。

# FAQ

1)  コンソールに接続されているゲームパッドが 1 つしかないのに、2 つ
    (またはそれ以上) のゲームパッドが表示されるのはなぜですか?\
    **回答**:Xbox One Manager が起動され、devkit
    に接続されていると、ゲームパッドとしてコントローラーの一覧に表示される場合があります。Xbox
    One Manager
    を終了し、コントローラーが削除したイベントを確認してください。

2)  Xbox One Manager
    のゲームパッドでサインインしたとき、ゲームパッドが関連付けられないのはなぜですか?\
    **回答**:Xbox One Manager
    のゲームパッドは、ドロップダウンから選択して、異なるユーザーに関連付けることができます。この関連付けは、この特定のゲームパッドに対して優先されます。

# 更新履歴

**初期リリース:**Microsoft ゲーム開発キット (2020 年4月)

# プライバシーに関する声明

サンプルをコンパイルして実行すると、サンプルの使用状況を追跡するため、サンプル実行可能ファイルのファイル名が
Microsoft に送信されます。このデータ収集を無効にするには、「Sample Usage
Telemetry」とラベル付けされた Main.cpp
内のコードのブロックを削除します。

Microsoft のプライバシー ステートメントの詳細については、「[Microsoft
のプライバシー
ステートメント](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。
