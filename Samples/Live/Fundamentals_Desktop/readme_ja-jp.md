  ![](./media/image1.png)

#   PC Fundamentals のサンプル

*このサンプルは、Microsoft ゲーム開発キット (2019 年 11 月)
に対応しています。*

# 

# 説明

このサンプルでは、Xbox Live
にサインインするための方法、およびライセンスをチェックして現在サインインしているユーザーがゲームを所有していることを確認するための方法を示します。また、ストアに公開されているバージョンと比べて、アプリが最新の状態であることを確認するために、更新のチェックを実行します。

![](./media/image3.png)

# 前提条件

-   Windows SDK 10.0.18362.1

-   Microsoft GRDK 190500 (2019 年 5 月) 10.1.18362.1021

-   Visual Studio 2017

-   Xbox テスト アカウントがサンドボックス XDKS.1 で最初に Xbox
    アプリにサインインし、次にストア アプリにサインインしていること

> テスト
> アカウントを使用してストア内のサンプルのライセンスを取得していること
> (\
> `ms-windows-store://pdp/?productid=9NRL15W975GM` を実行する)

# サンプルのビルド

サンプルは、VS2017 でビルドするように構成されています。このサンプルは PC
のみを対象としているため、プラットフォーム "Gaming.Desktop.x64"
のみ使用できます。

# サンプルの実行

XStore API
の使用に関する主な特徴は、機能させるには有効なライセンスが求められるという点です。これは起動時にライセンス
サービスを呼び出すことで確認されます。これが利用できない場合、API
は一般に、有効なライセンスが見つからないことを示す 0x803f6107
を返します。

テスト
アカウントの有効なライセンスを取得するには、次のコマンドを実行して、サンプルの製品のストア
ページに直接アクセスします。

`ms-windows-store://pdp/?productid=9NRL15W975GM`

XDKS.1 サンドボックスからテスト アカウントを使用して Xbox アプリ\*
にサインインし、次に、同じテスト アカウントを使用して Windows
ストアにもサインインする必要があることに注意してください。

ストアからインストールされたサンプルは、正しくライセンスが付与されて機能しますが、旧バージョンのサンプルを表している場合があります。Visual
Studio
でビルドされたサンプルを動作させるには、追加のセットアップが必要です。2019
年 11 月の GDK の場合、F5
キーを使用してサンプルを実行しただけでは、デバッグ
バージョンが適切に登録されず、適切なライセンス情報にリンクしません。さらに、展開されたルーズ
ビルドでは、更新プログラムのダウンロードとインストールのシナリオが正しく実行されません。

## サンプルの起動

ローカルでビルドされたルーズ バージョンを有効にするには、次の手順で
add-appxpackage コマンドを実行する必要があります。この場合、含まれている
MicrosoftGame.config
を使用して、ビルド済みのサンプルを登録します。このとき、ライセンスが関連付けられている、ストアからダウンロードしたパッケージと同じ名前および
ID を使用します。

2019 年 11 月の GDK
の場合は最後に、ライセンスを正しく機能させるために、スタート メニュー
(またはピン留めされている場合はタスク バー)
からアプリを起動する必要があります。F5 キーを使用したり、.exe
を直接実行したりすることはできず、このような操作を行った場合はエラー
0x803f6107 が発生します。

ローカルでビルドされたバージョンのサンプルが実行されるように設定するには、次の操作を行います。

1.  [サンドボックスを XDKS.1
    に切り替えます](https://docs.microsoft.com/en-us/gaming/xbox-live/xbox-live-sandboxes)

2.  テスト アカウントを使用して、Xbox アプリ\* にログインします
    (このサンドボックスでは、あらゆるテスト
    アカウントが動作するはずです)

3.  同じテスト アカウントを使用して Windows ストア
    アプリにログインします

4.  サンプルをビルドします

5.  **2019 年 11 月の GDK より新しい場合**:F5

6.  **2019 年 11 月の GDK の場合**:

    a.  Visual Studio 2017 のコマンド プロンプトを開きます

    b.  上記で説明したように、次のコマンドを実行してアプリを登録します\
        wdapp register \[Gaming.Desktop.x64\\Debug
        フォルダーの絶対パス\]

    c.  スタート メニューからアプリを起動します (F5
        キーを使用したり、.exe を直接実行したりすると、ストア API
        の結果を確認するときにエラー 0x803f6107 になります)

    d.  必要に応じてデバッガーをアタッチします

\* Xbox アプリの場合、これは、Xbox コンソール コンパニオン
アプリであるか、ネットショップを提供していて Game Pass
情報を保持している新しい Xbox
アプリのいずれかになります。後者の場合、ストア
アプリのアカウントと一致しない新しいアカウントに切り替えると、調整を求めるメッセージが表示されます。

## 更新プログラムのテスト

展開されているルーズ ビルドでは、(パッケージとは違って)
更新プログラムの有無 (つまり XStoreQueryGameAndDlcPackageUpdatesAsync)
を確認できるのは、コンテンツ ID
が、ストアから取得された公開済みパッケージのもの
(1062A2A1-C314-4DDC-94A2-424693687D97)
と一致する場合に限られます。これは次のレジストリ
エントリで確認できます。

`HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Store\\ContentId\\41336MicrosoftATG.ATGSimpleLiveSample_dspnxghe87tn0`

この設定は、ストアのサンプル
アプリが完全にインストールされている場合は適切に行われるはずです。そうではなく、最初のアプリのインストール
インスタンスがルーズ
ビルドによるものである場合は、手動での設定が必要なこともあります。

更新プログラムのダウンロードと適用を実際にテストするには、**パッケージ**
ビルドを使用する必要があります。

1.  *createmsixvc.cmd* を使用して v1 パッケージを作成します

2.  *wdapp install \<v1 msixvc\>*

3.  microsoftgame.config を編集してバージョンを上げます

4.  Visual Studio でアプリを展開して、変更内容が
    Gaming.Desktop.x64/Debug にコピーされるようにします

5.  *createmsixvc.cmd* を使用して新しいバージョンで v2
    パッケージを作成します

6.  *wdapp update \<v2 msixvc\> /m*

この時点で、v2
が使用可能な必須の更新プログラムとしてステージングされます。v1 (ステップ
2 でインストールされたもの)
を起動すると、使用可能な更新プログラムが検出され、\[Download &
Install\]\\(ダウンロードとインストール\\)
ボタンが表示されます。このボタンをクリックすると、アプリが終了し、ゲームの更新がシミュレートされます。

更新完了後、タイトルを起動すると v2 が実行されます。PowerShell
で以下を実行すると、インストールされているバージョンを確認できます。

`get-appxpackage 41336MicrosoftATG.ATGSimpleLiveSample`

これがテスト可能な唯一の更新フローです。署名の違いにより、公開済みのストア
パッケージに上位バージョンがあったとしても、これを更新プログラムとして検出することはできません。ストア
パッケージは、上位バージョンのストア パッケージにのみ更新されます。

# 実装に関する注意事項

複数のユーザーがサインインしている場合、StoreContext
は、ユーザーが変更したコールバックの最新のアカウントに割り当てられますが、これはサンプルに表示されているアカウントと一致しない場合もあります。ストア操作はマルチユーザー
シナリオでは実際にはうまく動作しないため、A を押したアカウントに
StoreContext を割り当てることが通常は適切です。Xbox (ベータ)
アプリを使用してサインインするのが、アカウントの一貫性を検出して確認するための最適な方法です。

# プライバシーに関する声明

サンプルをコンパイルして実行すると、サンプルの使用状況を追跡するため、サンプルの実行可能ファイルのファイル名が
Microsoft に送信されます。このデータ収集を無効にするには、「Sample Usage
Telemetry」とラベル付けされた Main.cpp
内のコードのブロックを削除します。

Microsoft のプライバシーに関する声明の詳細については、「[Microsoft
プライバシー
ステートメント](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。

# 更新履歴

**初期リリース:**2019 年 4 月

**更新:** 2020 年 1 月
