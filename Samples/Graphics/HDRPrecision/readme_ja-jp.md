# HDR 精度のサンプル

*このサンプルは、Microsoft Game Development Kit と互換性があります (2022 年 3 月)*

# 説明

このサンプルでは、以下で HDR をレンダリングする際に異なる形式とカラー スペースを使う場合、精度と GPU パフォーマンスがどのように影響を受けるかについて説明します。
フラグにより、一部の GPU 処理をディスプレイ ハードウェアにオフロードする可能性があります。また、一部の組み合わせでは、最終的な値でより高い精度で表示されます。 また、このサンプルでは、HDR シーンをレンダリングする間に 999e5 形式の使用も示します。 ![背景パターンの説明が自動生成されました](./media/image1.jpeg)
| | |
|---|---|
|Xbox Series X|S 本体。 たとえば、スワップ バッファーの組み合わせ|


# サンプルのビルド

利用可能なプラットフォームは Gaming.Xbox.Scarlett.x64 です。 *詳細については、**GDK ドキュメント*の「__サンプルの実行__」を参照してください。
| | |
|---|---|
|このサンプルは Xbox Series X|S でのみ動作するため、唯一の解決策です|


# Controls

| 操作 | ゲームパッド |
|---|---|
| HDR シーン レンダー ターゲットの形式を変更する | A ボタン |
| スワップ バッファーの色空間を変更する | X ボタン |
| スワップ バッファー ガンマ曲線の変更 | Y ボタン |
| ランプの明るさを調整する | D-pad |
| ランプ/イメージのレンダリングを切り替える | B button |
| 次/前の画像を選択 | 左/右ショルダー |
| Exit | ビュー ボタン |

# 実装メモ

**HDR シーン レンダリング**

このサンプルでは、HDR シーン レンダリングに次のレンダー ターゲット形式を使用できます。 999e5 は、Xbox でレンダー ターゲット形式として使用できます
ランプの明るさを調整して暗い領域と明るい領域の精度を調べる方向パッド。 "A" ボタンを使用して、形式を切り替えます。
| | |
|---|---|
|Xbox One のようなテクスチャ形式だけではない、シリーズ X|S 本体。 |を使用する

```cpp
DXGI_FORMAT HDRBackBufferFormat[] = { DXGI_FORMAT_R9G9B9E5_SHAREDEXP,
                                      DXGI_FORMAT_R11G11B10_FLOAT,
                                      DXGI_FORMAT_R32G32B32A32_FLOAT };
```


**スワップ バッファー**

色変換とガンマ曲線の適用。 したがって、HDR タイトルでは、GPU で HDR10 変換を処理するか、ディスプレイ ハードウェアで無料で実行するかを選択できます。 **ガンマ曲線**
| | |
|---|---|
|Xbox Series X|S 本体のディスプレイ ハードウェアは以下のことが可能です|


HDR10 では、本体が ST.2084 ガンマ曲線でエンコードされたディスプレイに画像を送信する必要があります。 タイトルは、おそらく最後のポストプロセッシング描画呼び出しにおいて、シェーダーで ST.2084 ガンマ曲線を適用できます。 ガンマ曲線の実装は、LinearToST2084() 関数で見つけることができます。これはかなりの量の ALU 命令ですが、帯域幅コストなどの他の要因があるため、シェーダーで十分なパフォーマンスが得られる可能性があります。 シェーダーにガンマ曲線を実装する場合、スワップ バッファー形式は 10:10:10:2 にする必要があります。

タイトルがディスプレイ ハードウェアにその変換を行いたい場合、スワップ バッファー形式は 999e5 である必要があり、シェーダーは正規化された線形値をレンダリングする必要があります。 "スイッチ (GammaCurve)" セクションの PerpareSwapBuffer.hlsl のコードを参照してください。

Y ボタンを使用して、形式を切り替えます。

```cpp
DXGI_FORMAT SwapBufferFormat[] = { DXGI_FORMAT_R9G9B9E5_SHAREDEXP,
                                   DXGI_FORMAT_R10G10B10A2_UNORM };
```


正しいプレゼント フラグを使用して、スワップ バッファー内の内容をグラフィックス ドライバーに伝える必要があります。 シェーダーが正規化された線形値を出力する場合、ガンマ 1.0 を参照する DXGI_COLOR_SPACE_RGB_FULL\_**G10**\_NONE\_\* フラグのいずれかが必要です。 シェーダーが ST.2084 ガンマ曲線を出力する場合は、DXGI_COLOR_SPACE_RGB_FULL\_**G2084**\_NONE\_\* のいずれかのフラグが必要です。

**色の変換**

HDR10 では、本体が Rec.2020 色空間にあるディスプレイに画像を送信する必要があります。 現在のほとんどのタイトルは Rec.709 を使用してマスターされており、一部は P3-D65 色空間に拡張されています。 そのため、色を Rec.2020 に回転させる必要があります。 タイトルは、シェーダーで色の回転を行ったり、ディスプレイ ハードウェアに色の回転を依頼したりできます。 ディスプレイ ハードウェアが変換を行う必要がある場合、タイトルはネイティブにマスターされたカラー空間と、スワップ バッファーにレンダリングされる色空間を指定する必要があります。

正しいプレゼント フラグを使用して、スワップ バッファー内の色空間をグラフィックス ドライバーに通知する必要があります。 次のいずれかのフラグを指定する必要があります。

```
DXGI_COLOR_SPACE_RGB_FULL_*_NONE_P709
DXGI_COLOR_SPACE_RGB_FULL_*_NONE_D65P3
DXGI_COLOR_SPACE_RGB_FULL_*_NONE_P2020
```

X ボタンを使用して、異なる色空間を切り替えます。

# 更新履歴

2021 年 3 月 26 日 -- サンプル作成。

# プライバシーに関する声明

サンプルをコンパイルして実行する場合、サンプルの使用状況を追跡するために、サンプルの実行可能ファイルのファイル名が Microsoft に送信されます。 このデータ コレクションからオプトアウトするには、Main.cpp の "サンプル使用状況テレメトリ" というラベルの付いたコードのブロックを削除します。

Microsoft のプライバシー ポリシー全般の詳細については、「[Microsoft のプライバシーに関する声明](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。


