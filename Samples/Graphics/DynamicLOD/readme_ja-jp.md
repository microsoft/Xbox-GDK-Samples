![](./media/image1.png)

# 動的 LOD サンプル

*このサンプルは、Microsoft Game Development Kit (2022 年 3 月) および Windows 10 (バージョン 2004) 2020 年 5 月の更新プログラムと互換性があります*

# 説明

このサンプルは、アンプリフィケーション シェーダーを活用して、任意の数のインスタンスに対して GPU 全体でインスタンスごとの視錐台カリングおよびメッシュ詳細レベル (LOD) 選択を行う方法を示します。 メッシュ シェーダー パイプラインを使用すると、この技術は、単一のアンプリフィケーションおよびメッシュ シェーダー パイプラインの状態オブジェクトにきちんと適合します。

![](./media/image3.png)

# サンプルのビルド

Project Scarlett を使用している場合は、アクティブなソリューション プラットフォームを `Gaming.Xbox.Scarlett.x64` に設定します。

適切なハードウェアと Windows 10 リリースで PC を使用する場合は、アクティブなソリューション プラットフォームを `Gaming.Deskop.x64` に設定します。

このサンプルでは、Xbox One はサポートされていません。

*詳細については、**GDK ドキュメント*の「__サンプルの実行__」 を参照してください。

# サンプルの使用方法

標準コントロールを使用してカメラを動かします。 視覚化モードと、インスタンスを推定するメソッドを使用します。 カリングを無効にするか、LOD 選択を強制的にレベル 0 (最も詳細) にして、frustum カリングと LOD 選択のインスタンスが GPU に与える影響を観察します。

# Controls

| 操作 | ゲームパッド | キーボード |
|---|---|---|
| カメラを移動する | 左サムスティック | WASD キーまたは方向キー |
| カメラを回転させる | 右サムスティック | LMB + マウスを長押しする |
| カメラを再設定 | 右サムスティック (プッシュ) | \- |
| インスタンス化モードの変更 | A | Tab |
| レンダリング モードの変更 | X | Space キー |
| インスタンス化レベルの変更 | 右肩 & トリガー | +/- |
| 強制 LOD 0 の切り替え | Y | 左 Shift キー |
| カリングの切り替え  | B | 左コントロール |
| Exit | ビュー ボタン | Esc キー |

# 実装メモ

増幅シェーダー ステージは、メッシュ シェーダー パイプラインのメッシュ シェーダー ステージの前に置きます。 これはコンピューティングに似たシェーダー ステージであり、その目的は、未処理のジオメトリ ワークロードを決定し、データのペイロード バッファーを設定し、ジオメトリを処理するために必要な数のメッシュ シェーダー スレッド グループを起動することです。

CPU 側コードは、ユーザー入力によってインスタンスを生成し、インスタンス バッファーを GPU リソースにアップロードします。 メッシュ LOD の配列は、LOD インデックスによって動的にインデックスを作成するシェーダー コード用の記述子テーブルを設定します。 増幅シェーダー (AS) は、1 つのシェーダー ウェーブのグループ サイズを持つよう構成されています。これにより、ウェーブ同期とメモリ バリアの必要性が回避されます。 CPU は、スレッドごとに 1 つのインスタンスをスケジュールするのに十分な AS ウェーブをディスパッチします。

AS スレッド グループの各スレッドは 1 つのインスタンスを処理します。ビューの frustum に対してカリングし、LOD 計算を実行します。 LOD インスタンス数は、ウェーブ組み込みを使用して取得および再構成され、ディスパッチされたメッシュ シェーダーのペイロード データを生成します (図 2、左)。 これは、LOD ごとのいくつかの異なるインスタンス数、オフセット、インスタンス インデックス リストで構成されます。 レンダリングするメッシュレットの合計数によって、DispatchMesh 増幅シェーダー組み込み関数を使用してディスパッチするメッシュ シェーダー スレッド グループの数が決まります。

![](./media/image4.png)

図: インスタンスとメッシュレット全体のメッシュ シェーダー スレッド グループのインデックス作成レイアウトの例。 このシナリオでは、4 つのインスタンスが LOD 0、6 つのインスタンスが LOD 1、および 52 メッシュ シェーダー スレッド グループを必要とする 3 つのインスタンスが LOD 2 です。 各 LOD の最後のメッシュレット (灰色が強調表示) は、複数のインスタンスを 1 つのメッシュ シェーダー スレッド グループにパックする場合があります。その頂点とプリミティブ数を許可します。 黄色で強調表示されたセルは各 LOD の最初のスレッド グループであり、赤い値は各 LOD レベルのグローバル オフセットです。スレッド グループの LOD インデックスを決定するには、スレッド グループ インデックスから減算する必要があります。 矢印は、LOD 境界を越えてスレッド グループ ID の継続を示すものです。

![](./media/image5.png)

図: 各増幅シェーダー スレッド グループからディスパッチされたメッシュ シェーダー スレッド グループに渡されるペイロード データ (左) (右側のスレッド グループの例)。 スレッド グループのインデックスを使用して、シェーダーは、処理する必要がある LOD、メッシュレット インデックス、インスタンス インデックスを計算できます。 グループ サイズはスレッド グループ内のスレッドの数であり、メッシュレットのサイズはメッシュレットの頂点とプリミティブ数の最大値です。

メッシュ シェーダーは単純なメッシュレット レンダリング シェーダーですが、ペイロード データを使用してその LOD、メッシュレット、インスタンス インデックスを計算するコードを使用します。 メッシュレットと頂点データは、LOD インデックスによって SRV 配列にインデックスを作成することで読み取られます。 LOD レベルの最後のメッシュレットでスレッド グループ使用率を最大にする場合、複数のインスタンスを 1 つのスレッド グループで処理できます。

# 既知の問題

最適化 (-Od) を無効にすると、PC で InstancedLodMS.hlsl が破損します。 これは、Windows SDK (10.0.19041) に付属するバージョンのシェーダー コンパイラ (dxc.exe) のバグが原因です。 この問題は、[GitHub](https://github.com/microsoft/DirectXShaderCompiler) で利用可能な最新リリースで修正されました。

# 更新履歴

2020 年 4 月 20 日 -- サンプルの作成。

2020 年 4 月 28 日 - メッシュ シェーダー パイプラインの作成に D3DX12 ヘルパーを使用するように更新済み

2021 年 9 月 2 日 -- Windows SDK dxc を使用して最適化を無効にするときの PC での破損に関するメモを追加しました

# プライバシーに関する声明

サンプルをコンパイルして実行する場合、サンプルの使用状況を追跡するために、サンプルの実行可能ファイルのファイル名が Microsoft に送信されます。 このデータ コレクションからオプトアウトするには、Main.cpp の "サンプル使用状況テレメトリ" というラベルの付いたコードのブロックを削除します。

Microsoft のプライバシー ポリシー全般の詳細については、「[Microsoft のプライバシーに関する声明](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。


