![](./media/image1.png)

# メッシュレットカリングのサンプル

*このサンプルは、Microsoft Game Development Kit (2022 年 3 月) および Windows 10 (バージョン 2004) 2020 年 5 月の更新プログラムと互換性があります*

# 説明

アンプリフィケーション シェーダーは、メッシュ シェーダー パイプラインのメッシュ シェーダー ステージの前にあるオプションのステージです。 その目的は、特定の GPU タスクで必要な数のメッシュ シェーダー スレッドグループを決定し、必要に応じて、データのペイロードをディスパッチされた MS 子スレッドグループに渡します。 これは、パイプラインのメッシュ シェーダー ステージに入る前にワークロードを軽減または拡張するために使用できます。

このサンプルでは、増幅シェーダーを利用して、メッシュレットごとのカリング メタデータを使用してカメラに対してメッシュレットをカリングする方法を示します。 目標は、起動前に表示される可能性があると考えられる部分のみに必要なメッシュ シェーダー スレッドグループの数を最小限に抑えられることです。

![](./media/image3.png)

# サンプルのビルド

Xbox Series X|S 開発キットを使用している場合は、アクティブ ソリューション プラットフォームを `Gaming.Xbox.Scarlett.x64` に設定します。

適切なハードウェアと Windows 10 リリースで PC を使用する場合は、アクティブなソリューション プラットフォームを Gaming.Desktop.x64 に設定します。

このサンプルでは、Xbox One はサポートされていません。

*詳細については、**GDK ドキュメント*の「__サンプルの実行__」 を参照してください。

# サンプルの使用方法

サンプルの焦点は、増幅シェーダーベースのメッシュレット カリング手法を示しています。 カリングのオン/オフを切り替えることができます。カリングが発生するカメラは、メイン カメラとデバッグ カメラの間で切り替えることができます。 デバッグ カメラの位置と向きは、ワールド空間内のカメラ モデルによって表されます。 カリング カメラの視錐台が視覚化され、視錐台カリングが発生する場所をより簡単に観察できます。

サンプルには、フラット シェーディングとメッシュレット視覚化という 2 つのレンダリング モードが用意されています。 メッシュレット ビュー モードでは、シーンからメッシュレットを選択して、境界球とメッシュレット内の法線の幅を表すコーンを視覚化できます。 そのメッシュレットの法線のコーンが退化したコーンを形成する場合 (球形よりも広い)、コーンはレンダリングされません。 また、ユーザーは、何らかの種類のメッシュの詳細レベルを 6 段階に切り替える場合もあります。

統計情報は画面に描画され、シーン オブジェクトレンダリングに対する GPU 経過時間とフレームからカリングされたメッシュレットの数が表示されます。

# Controls

| 操作 | ゲームパッド | キーボード |
|---|---|---|
| カメラを移動する | 左サムスティック/DPad | WASD キーまたは方向キー |
| カメラを回転させる | 右サムスティック | LMB + マウスを長押しする |
| カメラを再設定 | 右サムスティック (プッシュ) | 該当せず |
| デバッグ カメラの制御 | 左ショルダー | 左 Shift キー |
| カリングの切り替え | A ボタン | Tab |
| レンダリング モードの変更 | X ボタン | Space キー |
| カリング カメラの切り替え | B ボタン | Q |
| メッシュレットの選択 | Y ボタン | RMB |
| サイクル LOD | 右肩/トリガー | +/- |
| ヘルプ メニューの表示 | メニュー ボタン | 該当せず |
| Exit | ビュー ボタン | Esc キー |

# 実装メモ

この手法は、メッシュレット生成時のカリング データの生成から始まります。 メッシュレットリストが完了すると、各メッシュレットのオブジェクト空間境界球と法線コーンが計算されます。 この一連の手順を実行するアルゴリズムのサンプル コードは、別のサンプル MeshletConverter を介して提供されます。 その後、このデータは量子化によって圧縮され、ディスク上のメモリを節約し、帯域幅を読み取ります。

通常のコーンは、メッシュレット内の法線の *広がり* を表します。つまり、プリミティブのすべての法線を包み込むコーンです。 正規化された浮動小数点値の 4 タプルとして格納されます。平均法線方向を表す 3D 単位ベクトルと、そのベクトルと最も異なる三角形法線の間のドット積を表すスカラーです。

カリング テストの利点として、実際に格納されている値は -cos(*最大角度* + 90 hz) です。 三角形は、全球 (または法線の約 90%) にわたって観察可能であり、反転されたコーンが、この表面法線の背面に面する一連のビューの方向を含むので否定されるため、90 番目の値が追加されます。 これにより、カリング テストが単一ドット積と浮動小数点比較に減少します。

増幅シェーダーは、各スレッドで 1 つのメッシュレットを処理するように構成されています。 したがって、*n* 個のメッシュレットで構成されるメッシュをレンダリングするには、$\left\lceil \frac{n}{GroupSize} \right\rceil$ スレッドグループをディスパッチする必要があります。 スレッドグループ全体の操作にウェーブ組み込みの使用を容易にするために、プラットフォームのウェーブ サイズと等しいスレッドグループ サイズが選択されます。 各スレッドは、メッシュレットに対してビュー視錐台と通常のコーン カリング テストを実行します (ディスパッチ スレッド ID によってインデックスが作成されます)。 プレフィックス合計ウェーブ組み込みを使用すると、表示されるメッシュレットのインデックスは、起動されたメッシュ シェーダー スレッドグループのグループ共有メモリルックアップ テーブルに圧縮されます。 シェーダーはアンプリフィケーション シェーダー組み込み関数 DispatchMesh の呼び出しで終了し、メッシュ シェーダースレッドグループの必要な数を起動し、グループ共有参照テーブルをペイロード データとして指定します。

# 更新履歴

2020 年 4 月 20 日 -- サンプルの作成。

2020 年 4 月 28 日 - メッシュ シェーダー パイプラインの作成に D3DX12 ヘルパーを使用するように更新済み

# プライバシーに関する声明

サンプルをコンパイルして実行する場合、サンプルの使用状況を追跡するために、サンプルの実行可能ファイルのファイル名が Microsoft に送信されます。 このデータ コレクションからオプトアウトするには、Main.cpp の "サンプル使用状況テレメトリ" というラベルの付いたコードのブロックを削除します。

Microsoft のプライバシー ポリシー全般の詳細については、「[Microsoft のプライバシーに関する声明](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。


