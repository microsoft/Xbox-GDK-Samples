![](./media/image1.png)

# FastBlockCompress サンプル

*このサンプルは、Microsoft Game Development Kit と互換性があります (2022 年 3 月)*

# 説明

このサンプルでは、DirectCompute を使用して、従来の*高速ブロック圧縮*アルゴリズムを基に、実行時に BC1、BC3、BC5 の各形式で高速なテクスチャ圧縮を行う方法を示します。 また、このサンプルは、実行時とオフラインの圧縮モードを切り替えて、表示品質を比較することができます。

![](./media/image2.jpeg)

# サンプルのビルド

Xbox One 開発キットを使用している場合は、アクティブなソリューション プラットフォームを `Gaming.Xbox.XboxOne.x64` に設定します。

Xbox Series X|S を使用している場合は、アクティブなソリューション プラットフォームを `Gaming.Xbox.Scarlett.x64` に設定します。

*詳細については、* *GDK ドキュメント*の「__サンプルの実行__」を参照してください。

# サンプルの使用方法

| 操作 | ゲームパッド |
|---|---|
| 前または次の画像 | 左右バンパー |
| 前または次の圧縮方法 | 方向パッドの左または右 |
| 前または次のミップ レベル | 方向パッドを下または上へ |
| カメラを移動する | 右スティック |
| ズーム インまたはアウト | 左トリガーまたは右トリガー |
| 全画面表示と左右に並べて表示 | X |
| ブロックを強調表示する | A |
| サイクル差分モード | Y |
| Exit | ビュー ボタン |

# 背景

Xbox One には、排他的なアプリで使用できる 5 GB の統合メモリがあります。これは、Xbox 360 で利用できる 512 MB の 10 倍の劇的な増加です。 残念ながら、IO 帯域幅とストレージ メディアの容量は、かなりペースを維持していません。 ブルーレイ メディアは 49 GB を保持します。これは、Xbox 360 ゲーム ディスク バージョン 3 で使用できる 7.8 GB の 6.3 倍の増加です。

この事実は、ストリーミング インストールの導入と組み合わせることで、読み込み時間を最小限に抑え、ゲーム資産を使用可能なストレージ領域にパックするために、効率的な圧縮方法が依然として重要であることを意味します。

多くの場合、タイトルは、オフラインのイメージ圧縮形式を使用してゲーム テクスチャをエンコードすることで、大量のストレージ領域を節約できます。 Xbox One にはハードウェア JPEG デコーダーが組み込まれているため、JPEG が魅力的な選択肢になります。 ただし、JPEG ハードウェアはテクスチャをメモリ内の非圧縮 YUV 形式にデコードします。これはレンダリングには最適ではありません。 この方法を使用する場合、タイトルは実行時にテクスチャを GPU でサポートされているブロック圧縮形式のいずれかに再圧縮する必要があります。

このサンプルでは、GPU を使用して、テクスチャを BC1、BC3、BC5 形式に効率的に圧縮します。 オフライン ブロック圧縮に使用される標準アルゴリズムは、これまでリアルタイムで実行するには遅すぎ、サンプルで使用されるアルゴリズムは速度を重視して品質を大幅に犠牲にしていました。

現在のアルゴリズムではメモリ帯域幅がボトルネックになっているため、他の手法を使用すると、わずかなパフォーマンス ペナルティで顕著な品質向上を達成できる可能性があります。

# 実装メモ

サンプルの各 DirectCompute 圧縮シェーダーには、1 つのミップ バージョン、2 つのミップ バージョン、テール ミップ バージョンの 3 つのバリエーションがあります。

- 1 つのミップ シェーダーは、ソース テクスチャの 1 つのミップを圧縮します。

- 2 つのミップ シェーダーは、ソース テクスチャの 1 つのミップを読み取り、ミップをローカル データ ストア (LDS) メモリにダウン サンプリングします。 次に、シェーダーは、サンプリングされた元のバージョンとダウンしたバージョンの両方を圧縮した後、シェーダーが出力テクスチャに対応するミップ レベルを書き込みます。

このプロセスは、2 番目のミップ レベルのソース テクスチャからの読み取りを回避することで、メモリ帯域幅を節約します。 しかし、実際には、パフォーマンスの向上は、追加されたシェーダーの複雑さと、GPR と LDS の使用率が高いための占有率の低下によって大きく相殺されます。

- テール ミップ シェーダーは、1 回のディスパッチ呼び出しでソース テクスチャの 16×16 - 1×1 ミップ レベルを圧縮します。これは、異なるミップ レベルで動作するように異なるスレッドを選択することで行います。

最小ウェーブフロント サイズは 64 スレッドであるため、個別のディスパッチ呼び出しで各テール ミップを圧縮する手法では、使用可能なスレッドの大部分が無駄になります。 ウェーブフロント呼び出しとディスパッチ呼び出しを 1 つだけ使用することで、テール ミップ シェーダーは、この無駄な作業の大部分を回避します。

Direct3D では BC 形式のテクスチャを UAV としてバインドできないため、コンピューティング シェーダーからブロック圧縮テクスチャに直接書き込むことはありません。 サンプルでは、書き込み可能な形式の中間テクスチャをブロック圧縮テクスチャと同じメモリ位置にエイリアシングすることで、この制限を回避します。 中間テクスチャはサイズの 4 分の 1 で、各テクセルは圧縮テクスチャのブロックに対応します。

この方法でテクスチャ メモリをエイリアシングするには、2 つのテクスチャのタイリング モードとメモリ レイアウトが完全に一致している必要があります。 さらに、Direct3D はメモリのエイリアシングを忘れているため、GPU は、同じメモリ位置にエイリアス化された異なるリソースに対して動作する複数の描画またはディスパッチ呼び出しを同時にスケジュールできます。

つまり、中間テクスチャに書き込むシェーダーは、エイリアス化されたブロック圧縮テクスチャから読み取る描画呼び出しと同時にスケジュールされる場合があります。 これらの危険を防ぐには、適切なフェンスを手動で挿入する必要があります。

オフライン ライン圧縮アルゴリズムは [DirectXTex](https://github.com/Microsoft/DirectXTex/) で実装されています。

# 代替手段

このサンプルの主な目的は、従来の "JPG/FBC" ソリューションを、実行時にディスク上のテクスチャ ストレージとメモリ内消費を最小限に抑えるための他の代替手段と比較するためのテスト ケースを提供することです。

- Basis Universal ([GitHub](https://github.com/BinomialLLC/basis_universal/)) - このソリューションは、ディスク上のテクスチャを [ETC1](https://github.com/Ericsson/ETCPACK) のバリアントに圧縮します。このソリューションは、実行時に BC7 (モード 6) を含むさまざまな形式にトランスコードできます。 これにより、従来の JPG/FBC パイプラインと比較して、ディスク上のフットプリントが小さくなり、ターゲット GPU の広い配列がサポートされます。 .basis のマルチ GPU トランスコーディングの側面は、本体タイトルよりもはるかにモバイルに役立ちますが、ディスク上の節約を評価する価値のある形式です。

- XBTC - Xbox Series X|S では、XBTC 圧縮スキームで DirectStorage を使用できます。 **TextureCompression** サンプルを参照してください。

# 参照

Microsoft Advanced Technology Group。 Fast Block Compress サンプル。 Xbox 360 SDK。 2010 年 2 月。

Narkowicz、Krzysztof。 "GPU でのリアルタイム BC6H 圧縮"。 *GPU Pro 7* の編集: Wolfgang Engel (CRC Press)。 2016. (pg 219-228)。

Tranchida、Jason。 [GPU を使用したリアルタイムでのテクスチャ圧縮](http://www.gdcvault.com/play/1012554/Texture-compression-in-real-time)。 GDC 2010。 2010 年 3 月。

van Waveren、J.M.P[. リアルタイム DXT 圧縮](https://software.intel.com/sites/default/files/23/1d/324337_324337.pdf). Intel Software Network。 2006 年 5 月。

van Waveren、J.M.P.、Castaño、Ignacio。 [リアルタイム YCoCg-DXT 圧縮](https://www.nvidia.com/object/real-time-ycocg-dxt-compression.html)。 NVIDIA 開発者向けサイト。 2007 年 9 月。

van Waveren、J.M.P.、Castaño、Ignacio。 [リアルタイム ノーマル マップ DXT 圧縮](http://developer.download.nvidia.com/whitepapers/2008/real-time-normal-map-dxt-compression.pdf)。 NVIDIA 開発者向けサイト。 2008 年 2 月。

# 更新履歴

リリース日: 2019 年 9 月

# プライバシーに関する声明

サンプルをコンパイルして実行する場合、サンプルの使用状況を追跡するために、サンプルの実行可能ファイルのファイル名が Microsoft に送信されます。 このデータ コレクションからオプトアウトするには、Main.cpp の "サンプル使用状況テレメトリ" というラベルの付いたコードのブロックを削除します。

Microsoft のプライバシー ポリシー全般の詳細については、「[Microsoft のプライバシーに関する声明](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。


