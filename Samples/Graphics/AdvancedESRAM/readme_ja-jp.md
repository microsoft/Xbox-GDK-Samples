![](./media/image1.png)

# 高度な ESRAM のサンプル

*このサンプルは、Microsoft Game Development Kit と互換性があります (2022 年 3 月)*

# 説明

このサンプルでは、D3D リソースのメモリにエイリアスを効率的に作成する、高度な DirectX 12.x メモリ機能の使用法について説明します。 このサンプルのコアの API は、ID3D12CommandQueue::CopyPageMappingsX および ID3D12CommandQueue::CopyPageMappingsBatchX です。 これらの関数を使用すると、CPU のページ テーブル エントリを、GPU タイムライン上の GPU TLB にコピーできます。これにより、仮想 Direct3D リソースをその場でメモリ ページにマッピングできます。

このサンプルでは、上記の機能を利用して、個々の ESRAM ブロックと DRAM ブロックを 64 KB のページ分解能でマップする、一時的なリソース アロケーターを実装します。 これにより、ESRAM の全機能を活用するために使用されるフレームの GPU メモリ使用量が最適に圧縮されます。 そのインターフェイスは、XG メモリ ライブラリからのページ マッピング関数 XGMemoryLayout での、指定された側面をミラー化します。

このサンプルでは、ESRAM でのすべてのオプションと可視化機能が無効になった状況を、単純にレンダリングします。 ![](./media/image2.jpeg)
| | |
|---|---|
|注: Xbox One X および Xbox Series X|S には ESRAM がありません。 これらのプラットフォームにおいて|


# サンプルのビルド

Xbox One 開発キットを使用している場合は、アクティブなソリューション プラットフォームを `Gaming.Xbox.XboxOne.x64` に設定します。

Xbox Series X|S 開発キットを使用している場合は、アクティブ ソリューション プラットフォームを `Gaming.Xbox.Scarlett.x64` に設定します。

*詳細については、**GDK ドキュメント*の「__サンプルの実行__」を参照してください。

# サンプルの使用

サンプルの主な機能を使用すると、一時的なテクスチャ リソースが割り当てられる場所を操作できます。 フレームの中ではリソースとして、シーンの色、シーンの深さ、アウトライン用に 2 つ、ブルーム用に 2 つのテクスチャが使用されます。 リソースの ESRAM 構成は、リソース メモリの割合として左端に表示されます。 ESRAM レイアウトの視覚化機能では、各テクスチャの ESRAM および DRAM 構成に対する変更を即時フィードバックします。 各リソースの ESRAM フットプリントは Y 軸に沿って表示され、その有効期間は X 軸に沿って表示されます。 時間軸に平行して使用される GPU タイミングは、ボタンを押すと更新できます。

## Controls

| 操作 | ゲームパッド |
|---|---|
| カメラを原点に近づけて/遠ざけて移動する | 左側のサムスティックを上げる/下げる |
| カメラの周回 | 右サムスティック |
| カメラのリセット | 右サムスティック (クリック) |
| 一時的なテクスチャの循環 | 方向パッド (左/右) |
| ESRAM の割合の変更 | 方向パッド (上/下) |
| 強調表示されたオブジェクトの循環 | LB/RB |
| タイムラインの更新 | A ボタン |
| Exit | ビュー ボタン |

# 実装メモ

ESRAM と DRAM から割り当てられた 64 KB のメモリ ページ (ページ プール) のブロックをマップするために、大きな仮想アドレス空間が作成されます。 ページ プールは、ID3D12Device::RegisterPagePoolX を使用して DirectX12 に登録され、使用されなくなったときには ID3D12Device::UnregisterPagePoolX により登録解除されます。 このマッピングは、GPU ページ テーブルに直接コピーするための、CPU ページ テーブル エントリのステージとしての機能を持ちます。

ID3D12CommandQueue::CopyPageMappingsX または ID3D12CommandQueue::CopyPageMappingsBatchX 関数が、上記のページ プール内のページ範囲を、GPU タイムライン上の指定された GPU 仮想アドレスにマップすることを可能にします。 これにより、仮想 Direct3D リソースを 64 KB の物理ページに対し、柔軟かつ即座にマップできるようになります。 この機能により、リソース間でのメモリ エイリアシングが、非常に楽な通常の作業になります。

![](./media/image3.png)

図 1: サンプルで使用されているメモリ マッピングの枠組み。 ESRAM は、仮想アドレス空間の最初の 32 MB に使用可能な場合にマップされる一方で、4 MB の DRAM ページ プールは、必要に応じて付加されます。

ページ ブロックの作成と管理は、PageAllocator クラスによって実行されます。 仮想アドレス範囲が指定されると、アロケーターはこの範囲に対し、ページ プールを必要に応じて順番にマップします。 その後、このページ プールは、'RegisterPagePoolX' により DirectX12 に登録されます。 アロケーター ページの使用状況は完全に追跡されます。ページは最初から最後に向けて割り当てられ、解放されたページは置き換えられます。

仮想 Direct3D リソースの管理は、TransientCache により実行されます。 これらの作成はオンデマンドで行なわれますが、一般的なリソースを再作成することによる不要なオーバーヘッドを回避するために、キャッシュされます。 これらのリソースが割り当てるのは仮想アドレス空間のみなので、キャッシュによるメモリ オーバーヘッドは事実上ゼロです。 各リソースは、フレームごとに 1 回だけ割り当てることができます。

この TransientAllocator クラスは、ページ アロケーターと一時的なキャッシュを使用して、ユーザーへのリソース要求を処理します。 リソースが要求された場合、このクラスは、TransientCache からインスタンスを取得します。 次に、PageAllocators から必要な数のページを割り当て、トークンを解析して 1 つのページ レベルに対し ESRAM と DRAM のどちらを使用するかを決定します。 その上で、後に 'CopyPageMappingsBatchX' に提供するための適切な構造体が生成されます。実際には、構造体 D3D12XBOX_PAGE_MAPPING_BATCH およびD3D12XBOX_PAGE_MAPPING_RANGE のベクトルです。

![サンプルのスクリーンショット](./media/image4.png)

図 2: メモリ要件を満たすために、ページ プール内のページ範囲にマップされている仮想リソース。 これらのマッピングは、CopyPageMappingsX および CopyPageMappingsBatchX 呼び出しの結果です。 見てわかりやすくするために、この視覚化では 2 つのリソースのみが使用されており、メモリはエイリアス化されていません。 ただし、メモリ エイリアシングは、この手法の利点として期待される機能す。

メモリ エイリアシングのためには、TransientAllocator がシェーダーとキャッシュフラッシュを必要に応じて実行する役割も担います。 DirectX12 では、フラッシュがリソース バリアの一部として挿入されます。 メモリ エイリアシングを実行するためにこのシステムを回避したので、独自のフラッシュを手動で挿入する必要があります。 TransientAllocator は、リソースの関連付けられたビューを調べることで、フラッシュすべきシェーダー ステージとキャッシュを決定します。

最後に、割り当てられた一時的なリソースを使用するコマンド リストをコマンド キューに送信する前に、TransientAllocator で 'Finalize' を呼び出してリソース マッピングを完了する必要があります。 この時点で、コマンド キューに CopyPageMappingsBatchX 呼び出しが配置されます。これにより、リソースのメモリ マッピングが、後続のコマンド リストで使用するためにセットアップされます。

# 更新履歴

2018 年 8 月 6 日 -- サンプル作成。

2019 年 12 月 17 日 -- Microsoft GDK にポーティング。

# プライバシーに関する声明

サンプルをコンパイルして実行する場合、サンプルの使用状況を追跡するために、サンプルの実行可能ファイルのファイル名が Microsoft に送信されます。 このデータ コレクションからオプトアウトするには、Main.cpp の "サンプル使用状況テレメトリ" というラベルの付いたコードのブロックを削除します。

Microsoft のプライバシー ポリシー全般の詳細については、「[Microsoft のプライバシーに関する声明](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。


