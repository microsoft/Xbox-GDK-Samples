![](./media/image1.png)

# Simple Meshlet サンプル

*このサンプルは、Microsoft Game Development Kit (2022 年 3 月) および Windows 10 (バージョン 2004) 2020 年 5 月の更新プログラムと互換性があります*

# 説明

このサンプルでは、データ構造について説明し、メッシュレットを使用したレンダリングの例を示します。 また、メッシュ シェーダー内でプリミティブ カリングを実行する方法についても示します。

![](./media/image3.png)

# サンプルのビルド

Xbox Series X|S を使用している場合は、アクティブなソリューション プラットフォームを `Gaming.Xbox.Scarlett.x64` に設定します。

適切なハードウェアと Windows 10 リリースで PC を使用する場合は、アクティブなソリューション プラットフォームを Gaming.Desktop.x64 に設定します。

このサンプルでは、Xbox One はサポートされていません。

*詳細については、**GDK ドキュメント*の「__サンプルの実行__」 を参照してください。

# サンプルの使用方法

カメラのコントロール以外にも、いじれるオプションがいくつか公開されています。

基になるメッシュレット構造の視覚的表現は、ボタンのクリックで切り替えることができます。色付きの各パッチは、最大サイズ 128 のメッシュレットを表します。

プリミティブ カリングは、必要に応じて切り替えることもできます。 'デバッグ' カメラがシーンに配置されています。これは、必要に応じてプリミティブがカリングされるビューとして使用できます。 これにより、ユーザーはカリングされたプリミティブを視覚化できます。 このカメラの位置と向きは、ボタンを押しながらカメラ コントロールを操作することで操作できます。

# Controls

| 操作 | ゲームパッド | キーボード |
|---|---|---|
| ビュー ベクターに沿ってカメラを回転/翻訳する | 左サムスティック | マウス ホイール |
| オービット カメラ | 右サムスティック | LMB + マウスを長押しする |
| カメラのパン | 方向パッド | WASD キーまたは方向キー |
| カメラを再設定 | 右サムスティック (プッシュ) | \- |
| メッシュレットの視覚化を切り替える | X | Space キー |
| プリミティブ カリングを切り替える | A | Tab |
| デバッグ カメラのカリングを切り替える | B | Q |
| カメラ コントロールのデバッグ (保留) | 右肩 | 左 Shift キー |
| メッシュ LOD のサイクル | 左右トリガー | プラス/マイナス キー |
| Exit | ビュー ボタン | Esc キー |

# 実装メモ

**メッシュレット**はその名の通り、大きなメッシュの固定サイズのプリミティブ チャンクです。 メッシュレット構造の最大サイズが選択され、メッシュ全体が処理されるまでプリミティブと頂点がメッシュレットにパックされます。 このようにして、メッシュはメッシュレットの配列になります。

実際の頂点データはこのプロセスによって変更されませんが、インデックス バッファーは 3 つの新しいバッファー (*メッシュレット リスト*、*一意の頂点インデックス リスト*、*プリミティブ リスト*) に置き換えられることに注意してください。 *メッシュレット リスト*の要素は、他の 2 つの構造への単純なオフセットとカウントです。これにより、各メッシュレットにどの頂点とプリミティブが含まれるかを定義します。 *一意の頂点インデックス リスト*には、各メッシュレットの重複除去された頂点インデックスのチャンクが含まれています。これらは、頂点バッファーに直接インデックスを作成するために使用されます。 *プリミティブ リスト*は、各メッシュレットのプリミティブのチャンクを定義します。 このリストの項目は、一意の頂点インデックス リストへのインデックスです。 各プリミティブ インデックスは、メッシュレットの一意の頂点インデックス サブ範囲に対してローカルであり、その範囲が 8 ビットのみに減少します。

この構造は、メッシュ シェーダーの固定サイズのスレッド グループに非常によくマップされます。各メッシュレットを 1 つのスレッド グループにマップできます。 各メッシュレットには固定の最大サイズがあるため、これは各スレッドが担当する作業とうまく関連付けられます。 これはシェーダー BasicMeshletMS.hlsl の基礎であり、実装に関しては非常に簡単です。

**プリミティブ カリング**は、複数のカリング テストに対するプリミティブごとのビューポートの関連性を判断するプロセスです。 メッシュ シェーダーは出力カウントを動的に指定するため、プリミティブの破棄は、送信から省略するだけで行われます。 メッシュ シェーダー ベースのプリミティブ カリングの基本的なワークフローは、次の手順です:

1. メッシュレット頂点をカリング空間に変換します (一般に表示、同種、または NDC)。

2. 変換された頂点からプリミティブを構築し、カリング テストを実行する

3. 存続しているプリミティブをマークして、存続している頂点をマークする

4. **圧縮**を通じて頂点とプリミティブの最終出力インデックスを決定する

5. プリミティブ インデックスを再マップされた頂点インデックスに再マップする

6. 通常どおりにエクスポートする

**圧縮**は、関連する作業項目と無関係な作業項目 (カリングされたものとカリングされていないもの) の両方を含む密なリストにインデックスを付ける疎リストを生成するアルゴリズムです。 このリストは、ルックアップ テーブルとして使用するインデックスの一覧の形式をとります。 スレッド グループ コンテキストでは、最も低い ID のスレッドが関連するすべての作業項目に直接アクセスできます。 このプロセスは、グループ共有メモリとグループ同期ポイントを使用して処理されるウェーブ間通信の必要性によってやや複雑になります。

# 既知の問題

最適化 (`-Od`) を無効にすると、PC 上で `CullMeshletMS.hlsl` が壊れます。 これは、Windows SDK (10.0.19041) に付属するバージョンのシェーダー コンパイラ (dxc.exe) のバグが原因です。 この問題は、[GitHub](https://github.com/microsoft/DirectXShaderCompiler) で利用可能な最新リリースで修正されました。

# 更新履歴

2019 年 10 月 31 日 -- サンプル作成。

2020 年 2 月 24 日 -- LOD サイクリングとデバッグ カメラ ビューの frustum 視覚化を追加しました。

2020 年 4 月 28 日 - メッシュ シェーダー パイプラインの作成に D3DX12 ヘルパーを使用するように更新済み

2021 年 9 月 2 日 -- Windows SDK dxc を使用して最適化を無効にするときの PC での破損に関するメモを追加しました

# プライバシーに関する声明

サンプルをコンパイルして実行する場合、サンプルの使用状況を追跡するために、サンプルの実行可能ファイルのファイル名が Microsoft に送信されます。 このデータ コレクションからオプトアウトするには、Main.cpp の "サンプル使用状況テレメトリ" というラベルの付いたコードのブロックを削除します。

Microsoft のプライバシー ポリシー全般の詳細については、「[Microsoft のプライバシーに関する声明](https://privacy.microsoft.com/en-us/privacystatement/)」を参照してください。


