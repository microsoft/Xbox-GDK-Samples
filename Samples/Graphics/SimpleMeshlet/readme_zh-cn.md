  ![](./media/image1.png)

#   简单网格片段示例

此示例与 Microsoft 游戏开发工具包预览版（2019 年 11 月）和 Windows
10"20H1"Insider for PC 兼容

# 说明

本示例介绍网格片段数据结构，并举例说明如何使用网格片段进行呈现。另外，还介绍如何在网格着色器内执行基元剔除。

![](./media/image3.png)

# 构建示例

如果使用 Project Scarlett，请将活动解决方案平台设置为
Gaming.Xbox.Scarlett.x64。

如果使用电脑且结合使用相应的硬件和 Windows 10
版本，请将活动解决方案平台设置为 Gaming.Desktop.x64。

本示例不支持 Xbox One。

有关详细信息，请参阅 GDK 文档中的"运行示例"。

# 使用示例

除了照相机控件之外，还提供了一些选项，供用户选择。

只需单击一下按钮，即可切换基础网格片段结构的可视化表示形式，每个彩色补丁代表一个最大尺寸为
128 的网格。

也可以随时切换基元剔除。场景中放置了一个"调试"照相机，可选择使用它作为基元的视图，并对基元进行剔除。这样用户就可以直观地看到被剔除的基元。按住一个按钮，同时操作照相机的控制按钮可以控制照相机的位置和方向。

# 控件

| 操作                         |  游戏手柄         |  键盘              |
|------------------------------|------------------|-------------------|
| 沿视图矢量旋转/平移相机      |  左操纵杆         |  鼠标滚轮          |
| 沿轨迹移动相机               |  右操纵杆         |  按住 LMB 操作鼠标 |
| 平移相机                     |  方向键           |  WASD 或箭头键     |
| 重置相机                     |  右操纵杆（按）   |  \-                |
| 切换网格片段可视化效果       |  X                |  空格键            |
| 切换基元剔除                 |  A                |  Tab               |
| 切换调试照相机剔除           |  B                |  Q                 |
| 调试照相机控件（保持）       |  右肩按钮         |  左移              |
| 循环网格 LOD                 |  左/右扳机键      |  加号/减号键       |
| 退出                         |  "视图"按钮       |  ESC 键            |

# 实现说明

从名称可以看出，网格片段表示较大网格固定大小的基元区块。选择一个最大大小的网格片段结构，然后将基元和顶点打包到网格片段中，直到处理完整个网格。这样的话，一个网格
就是网格片段的一个数组。

请注意，此过程不会更改实际的顶点数据，但将索引缓冲区替换为三个新缓冲区，即一个网格片段列表、一个唯一顶点索引列表和一个基元列表。网格片段列表中的元素是到其他两个结构的简单偏移和计数，这定义了每个网格片段中的顶点和基元。唯一顶点索引列表包含每个网格片段的一组去重顶点索引块，用于直接索引到顶点缓冲区。基元列表定义每个网格片段的基元块。此列表中的项是唯一顶点索引列表中的索引。每个基元索引都位于网格片段的唯一顶点索引子范围内，这就将其范围减小到仅
8 位。

这种结构可以很好地映射到网格着色器固定大小的线程组，每个网格片段可以映射到一个线程组。每个网格片段都有一个固定的最大尺寸，因此与每个线程将要负责的工作紧密相关。这是着色器
BasicMeshletMS.hlsl 的基础，实现起来非常简单。

基元剔除是针对多个剔除测试确定每个基元的视区相关性的过程。由于网格着色器动态指定其输出计数，因此只需在提交时省略掉基元即可完成剔除。基于网格着色器的基元剔除的基本工作流程如下：

1.  将网格片段顶点转换为剔除空间（通常为视图、同类或 NDC）。

2.  根据转换后的顶点构建基元并执行剔除测试

3.  标记尚存的基元 标记尚存的顶点

4.  通过压缩确定顶点和基元的最终输出索引

5.  将基元索引重新映射到已重新映射的顶点索引

6.  按常规方式导出

压缩是一种算法，它生成一个稀疏列表，并将其索引到一个紧凑列表中，其中包含相关和不相关的工作项目（已剔除项和未剔除项）。
此列表采用索引列表的形式，作为查询表使用。在线程组上下文中，这使得 ID
最低的线程可以直接访问所有相关工作项。这个过程有点复杂，因为必须要进行波间通信，而这个过程是通过组共享存储器和组同步点来处理的。

# 更新历史记录

2019 年 10 月 31 日 - 创建示例。

2020 年 2 月 24 日 - 已添加 LOD 循环和调试照相机视锥可视化效果。

# 隐私声明

在编译和运行示例时，示例可执行文件的文件名将发送给
Microsoft，用于帮助跟踪示例使用情况。要选择退出此数据收集，你可以删除
Main.cpp 中标记为"示例使用遥测"的代码块。

有关 Microsoft 的一般隐私策略的详细信息，请参阅《[Microsoft
隐私声明](https://privacy.microsoft.com/en-us/privacystatement/)》。
