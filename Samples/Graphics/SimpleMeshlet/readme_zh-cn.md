![](./media/image1.png)

# 简单 Meshlet 示例

*此示例与 Microsoft 游戏开发工具包（2022 年 3 月）和 Windows 10 （版本 2004）2020 年 5 月更新兼容*

# 说明

介绍 Meshlet 数据结构，并提供通过使用 Meshlet 进行渲染的示例。 它还演示如何在 Mesh 着色器内执行基元剔除。

![](./media/image3.png)

# 生成示例

如果使用 Xbox Series X|S，请将活动解决方案平台设置为 `Gaming.Xbox.Scarlett.x64`。

如果使用具有适当硬件和 Windows 10 版本的电脑，请将活动解决方案平台设置为 Gaming.Deskop.x64。

示例不支持 Xbox One。

*有关更多信息，请参阅*&nbsp;__运行示例__（位于 *GDK&nbsp;文档）中。*

# 使用示例

除了相机控件之外，还有一些选项已经公开了这些选项。

可通过单击按钮切换基础 meshlet 结构的可视化表示形式 - 每个彩色修补程序表示最大大小为 128 的 meshlet。

也可以随时切换基元剔除。 &ldquo;调试&rdquo;相机已放置在场景中，可选择将其用作要针对其剔除基元的视图。 这允许用户可视化已剔除的基元。 可通过按住按钮并操作相机控件来操作此相机的位置和方向。

# 控件

| 操作 | 游戏板 | 键盘 |
|---|---|---|
| 沿视图向量旋转/转换相机 | 左控制杆 | 鼠标滚轮 |
| 旋转相机 | 右控制杆 | 按住 LMB + 鼠标 |
| 平移相机 | 方向键 | WASD 或箭头键 |
| 重置摄像头 | 右控制杆（推） | \- |
| 切换 Meshlet 可视化效果 | X | 空格键
 |
| 切换基元剔除 | A | Tab |
| 切换调试相机剔除 | B | Q |
| 调试相机控件（保持） | 右侧肩部 | 左移 |
| 循环 Mesh LOD | 左/右扳机键 | 加/减键 |
| 退出 | &ldquo;视图&rdquo;按钮 | 退出 |

# 实现说明

**Meshlet** 正是它们的发音 &mdash; 较大 Mesh 的固定大小基元区块。 为 meshlet 结构选择最大大小，然后基元和顶点将打包到 meshlet 中，直到处理整个 Mesh 为止。 这样，Mesh 就包含一个 meshlet 数组。

请注意，此过程未更改实际顶点数据，但索引缓冲区替换为三个新缓冲区 - *meshlet 列表*、*唯一顶点索引列表* 和 *基元列表*。 *meshlet 列表*的元素是简单的偏移量和计数到其他两个结构中 -- 这定义了每个 meshlet 中的顶点和基元。 *唯一顶点索引列表* 包含每个 meshlet 的去重复顶点索引区块 -- 这些区块用于直接索引到顶点缓冲区。 *基元列表* 定义每个 meshlet 的基元区块。 此列表的项是唯一顶点索引列表中的索引。 每个基元索引都是 meshlet 的唯一顶点索引子范围的本地索引，这会将其范围减少到仅 8 位。

此结构很好地映射到 Mesh 着色器的固定大小线程组 -- 每个 meshlet 都可以映射到单个线程组。 每个 meshlet 都有固定的最大大小，因此这与每个线程将负责的工作非常相关。 这是着色器 BasicMeshletMS.hlsl 的基础，在实现方面非常简单。

**基元剔除** 是确定每个基元对多个剔除测试的视区相关性的过程。 由于 Mesh 着色器动态指定其输出计数，因此只需从提交中省略基元即可放弃基元。 基于 Mesh 着色器的基元剔除的基本工作流是以下步骤：

1. 将 meshlet 顶点转换为剔除空间（通常为视图、同质或 NDC。）

2. 从转换的顶点生成基元并执行剔除测试

3. 标记正在生存的基元标记正在生存的顶点

4. 通过 **压缩** 确定顶点和基元的最终输出索引

5. 重新映射基元索引以重新映射顶点索引

6. 像往常一样导出

**压缩**是一种产生稀疏列表的算法，该列表将索引到包含相关和不相关工作项（已剔除和未剔除）的密集列表中。 此列表采用要用作查阅表的索引列表的形式。 在线程组上下文中，这允许 ID 最低的线程直接访问所有相关工作项。 由于需要进行波间通信（通过使用组共享的内存和组同步点进行处理），此过程有些复杂。

# 已知问题

禁用优化 （`-Od`） 会导致电脑 `CullMeshletMS.hlsl` 中断。 这是因为 Windows SDK (10.0.19041) 随附版本中的着色器编译器 (dxc.exe) 中存在 bug。 此问题已在 [GitHub](https://github.com/microsoft/DirectXShaderCompiler) 上提供的最新版本中得到修复。

# 更新历史记录

2019/10/31 &ndash; 创建示例。

2020 年 2 月 24 日 -- 添加了 LOD 循环和调试相机视图 Frustum 可视化效果。

2020/4/28 - 已更新为使用 D3DX12 帮助程序创建 Mesh 着色器管道

2021/9/2 -- 添加了有关在使用 Windows SDK dxc 禁用优化时在电脑上中断的注释

# 隐私声明

在编译和运行示例时，将向 Microsoft 发送示例可执行文件的文件名以帮助跟踪示例使用情况。 若要选择退出此数据收集，你可以删除 Main.cpp 中标记为&ldquo;示例使用遥测&rdquo;的代码块。

有关 Microsoft 的一般隐私策略的详细信息，请参阅 [Microsoft 隐私声明](https://privacy.microsoft.com/en-us/privacystatement/)。


